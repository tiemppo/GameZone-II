<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameZone II</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tektur:wght@400..900&display=swap" rel="stylesheet">
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root[data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --accent-primary: #ff6b35;
            --accent-secondary: #ffa500;
            --border-color: rgba(255, 107, 53, 0.3);
            --shadow: rgba(0, 0, 0, 0.5);
        }

        :root[data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent-primary: #ff6b35;
            --accent-secondary: #ff8c42;
            --border-color: rgba(255, 107, 53, 0.2);
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tektur', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .blob-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .blob {
            position: absolute;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            filter: blur(60px);
            opacity: 0.3;
            animation: blob-animation 25s ease-in-out infinite;
        }

        :root[data-theme="dark"] .blob {
            background: linear-gradient(45deg, 
                rgba(255, 107, 53, 0.4),
                rgba(255, 165, 0, 0.3),
                rgba(255, 140, 66, 0.4)
            );
        }

        :root[data-theme="light"] .blob {
            background: linear-gradient(45deg, 
                rgba(255, 107, 53, 0.2),
                rgba(255, 165, 0, 0.15),
                rgba(255, 140, 66, 0.2)
            );
        }

        .blob:nth-child(1) {
            width: 600px;
            height: 600px;
            top: -200px;
            left: -250px;
            animation-delay: 0s;
        }

        .blob:nth-child(2) {
            width: 700px;
            height: 700px;
            top: 50%;
            right: -350px;
            animation-delay: -10s;
        }

        .blob:nth-child(3) {
            width: 500px;
            height: 500px;
            bottom: -200px;
            left: 40%;
            animation-delay: -20s;
        }

        @keyframes blob-animation {
            0%, 100% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
            25% {
                transform: translate(100px, -80px) scale(1.1) rotate(90deg);
            }
            50% {
                transform: translate(0, 120px) scale(0.9) rotate(180deg);
            }
            75% {
                transform: translate(-80px, -60px) scale(1.05) rotate(270deg);
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-secondary);
            padding: 20px 0;
            box-shadow: 0 2px 10px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid var(--accent-primary);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--accent-primary);
        }

        .theme-icon {
            width: 20px;
            height: 20px;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-badge {
            background: var(--bg-card);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-badge {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 700;
        }

        .verification-badge {
            background: #44ff44;
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 700;
        }

        .unverified-badge {
            background: #ff4444;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Tektur', sans-serif;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.5);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin: 30px 0;
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 15px;
            flex-wrap: wrap;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .nav-tab {
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-card);
            border: 2px solid transparent;
            font-weight: 600;
        }

        .nav-tab:hover {
            border-color: var(--accent-primary);
        }

        .nav-tab.active {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            color: #000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 50px rgba(255, 107, 53, 0.3);
            margin: 20px;
        }

        .dialog-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .dialog-modal.active {
            display: flex;
        }

        .dialog-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 50px rgba(255, 107, 53, 0.3);
            margin: 20px;
        }

        .dialog-content h3 {
            color: var(--accent-primary);
            margin-bottom: 15px;
            font-size: 24px;
        }

        .dialog-content p {
            color: var(--text-primary);
            margin-bottom: 25px;
            line-height: 1.6;
            white-space: pre-line;
        }

        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .dialog-buttons button {
            min-width: 100px;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: var(--accent-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'Tektur', sans-serif;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .error {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #ff4444;
        }

        .success {
            color: #44ff44;
            background: rgba(68, 255, 68, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #44ff44;
        }

        .info {
            color: var(--accent-primary);
            background: rgba(255, 107, 53, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-primary);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: var(--accent-primary);
            margin-bottom: 20px;
            font-size: 32px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .game-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }

        .game-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-primary);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .game-card h3 {
            color: var(--accent-primary);
            margin-bottom: 10px;
            font-size: 22px;
        }

        .game-card p {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .game-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .coming-soon {
            opacity: 0.6;
            position: relative;
        }

        .coming-soon::after {
            content: 'COMING SOON';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background: var(--accent-primary);
            color: #000;
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: 900;
            font-size: 14px;
        }

        .leaderboard-table {
            width: 100%;
            background: var(--bg-card);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 15px;
            text-align: left;
        }

        .leaderboard-table th {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            color: #000;
            font-weight: 700;
        }

        .leaderboard-table tr:nth-child(even) {
            background: rgba(255, 107, 53, 0.05);
        }

        .rank-1 { color: #ffd700; font-weight: 900; }
        .rank-2 { color: #c0c0c0; font-weight: 900; }
        .rank-3 { color: #cd7f32; font-weight: 900; }

        .hidden {
            display: none;
        }

        .chat-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            height: 600px;
        }

        .chat-rooms {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--border-color);
            overflow-y: auto;
        }

        .chat-room-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .chat-room-item:hover {
            background: rgba(255, 107, 53, 0.1);
            border-color: var(--accent-primary);
        }

        .chat-room-item.active {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            color: #000;
        }

        .chat-messages {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .messages-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message {
            background: rgba(255, 107, 53, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .message-author {
            color: var(--accent-primary);
            font-weight: 700;
            margin-bottom: 5px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Tektur', sans-serif;
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .chat-rooms {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="blob-container">
        <div class="blob"></div>
        <div class="blob"></div>
        <div class="blob"></div>
    </div>
    
    <header>
        <div class="header-content">
            <div class="logo">GAMEZONE II</div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    <svg id="themeIcon" class="theme-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <!-- Moon icon (shown in light mode, click to switch to dark) -->
                        <path id="moonIcon" style="display: none;" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/>
                        <!-- Sun icon (shown in dark mode, click to switch to light) -->
                        <g id="sunIcon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </g>
                    </svg>
                </button>
                <div id="userInfo" class="user-info"></div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="nav-tabs" id="navTabs"></div>
        
        <!-- Games Section -->
        <div id="gamesSection" class="section">
            <h2>Games</h2>
            <div class="games-grid">
                <div class="game-card">
                    <div class="game-icon">üéØ</div>
                    <h3>Aim Trainer</h3>
                    <p>Test and improve your aim with moving targets!</p>
                    <button class="btn btn-primary" onclick="showGameAlert('Aim Trainer')">Play Now</button>
                </div>
                <div class="game-card">
                    <div class="game-icon">üß©</div>
                    <h3>Memory Match</h3>
                    <p>Classic memory card matching game. How fast can you match them all?</p>
                    <button class="btn btn-primary" onclick="showGameAlert('Memory Match')">Play Now</button>
                </div>
                <div class="game-card">
                    <div class="game-icon">‚å®Ô∏è</div>
                    <h3>Type Racer</h3>
                    <p>Race against time and improve your typing speed!</p>
                    <button class="btn btn-primary" onclick="showGameAlert('Type Racer')">Play Now</button>
                </div>
                <div class="game-card">
                    <div class="game-icon">üßÆ</div>
                    <h3>Math Blast</h3>
                    <p>Solve math problems as fast as you can! Educational and fun.</p>
                    <button class="btn btn-primary" onclick="showGameAlert('Math Blast')">Play Now</button>
                </div>
                <div class="game-card coming-soon">
                    <div class="game-icon">üöÄ</div>
                    <h3>Space Shooter</h3>
                    <p>Classic arcade space shooter with waves of enemies!</p>
                    <button class="btn btn-secondary" disabled>Coming Soon</button>
                </div>
                <div class="game-card coming-soon">
                    <div class="game-icon">üèÉ</div>
                    <h3>Endless Runner</h3>
                    <p>Jump and dodge obstacles in this endless running game!</p>
                    <button class="btn btn-secondary" disabled>Coming Soon</button>
                </div>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboardSection" class="section">
            <h2>Leaderboard</h2>
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Score</th>
                        <th>Level</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px;">No players yet. Be the first!</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- School Portal Section -->
        <div id="schoolPortalSection" class="section">
            <h2>School Portal</h2>
            <div class="games-grid">
                <div class="game-card">
                    <div class="game-icon">üìä</div>
                    <h3>Skyward</h3>
                    <p>Student Information System - Check grades, attendance, and schedule</p>
                    <button class="btn btn-primary" onclick="window.open('https://www.q.wa-k12.net/lkwashSTS', '_blank')">Open Skyward</button>
                </div>
                <div class="game-card">
                    <div class="game-icon">üìÖ</div>
                    <h3>Flexisched</h3>
                    <p>Flexible scheduling system for managing your school day</p>
                    <button class="btn btn-primary" onclick="window.open('https://evergreen.flexisched.net/login', '_blank')">Open Flexisched</button>
                </div>
                <div class="game-card">
                    <div class="game-icon">üîó</div>
                    <h3>Classlink</h3>
                    <p>Access all your school applications in one place</p>
                    <button class="btn btn-primary" onclick="window.open('https://myapps.classlink.com/home', '_blank')">Open Classlink</button>
                </div>
            </div>
        </div>

        <!-- Home Section -->
        <div id="homeSection" class="section">
            <h2>Home</h2>
            
            <!-- Level and XP Section -->
            <div class="games-grid" style="margin-bottom: 30px;">
                <div class="game-card" style="grid-column: 1 / -1;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <h3 style="color: var(--accent-primary); margin-bottom: 10px;">Level & XP</h3>
                            <p style="font-size: 48px; font-weight: 900; color: var(--accent-primary); margin: 0;">Level <span id="userLevel">1</span></p>
                            <p style="color: var(--text-secondary); margin-top: 5px;">XP: <span id="userXP">0</span> / <span id="userXPNeeded">100</span></p>
                        </div>
                        <div style="flex: 1; max-width: 400px;">
                            <div style="background: var(--bg-primary); height: 20px; border-radius: 10px; overflow: hidden; border: 2px solid var(--border-color);">
                                <div id="xpBar" style="background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Games Section -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: var(--accent-primary); margin-bottom: 15px;">Recent Games</h3>
                <div id="recentGamesList" class="games-grid">
                    <div class="game-card" style="text-align: center; padding: 40px;">
                        <p style="color: var(--text-secondary);">No games played yet. Start playing to see your recent games here!</p>
                    </div>
                </div>
            </div>

            <!-- Announcements Section -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h3 style="color: var(--accent-primary); margin: 0;">Announcements</h3>
                    <div id="announcementsAdminControls" style="display: none;">
                        <button class="btn btn-primary" onclick="showCreateAnnouncementModal()" style="font-size: 14px; padding: 8px 15px;">+ New Announcement</button>
                    </div>
                </div>
                <div id="announcementsList">
                    <!-- Announcements will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div id="chatSection" class="section">
            <h2>Chat Rooms</h2>
            <div class="chat-container">
                <div class="chat-rooms">
                    <h3 style="margin-bottom: 15px;">Rooms</h3>
                    <div class="chat-room-item active" onclick="switchChatRoom('general')">
                        # general
                    </div>
                    <div class="chat-room-item" onclick="switchChatRoom('gaming')">
                        # gaming
                    </div>
                    <div class="chat-room-item" onclick="switchChatRoom('homework')">
                        # homework-help
                    </div>
                    <div class="chat-room-item" onclick="switchChatRoom('offtopic')">
                        # off-topic
                    </div>
                </div>
                <div class="chat-messages">
                    <div class="messages-list" id="messagesList">
                        <div class="message">
                            <div class="message-author">System</div>
                            <div>Welcome to the chat! Be respectful and have fun.</div>
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMessage()">
                        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div id="statisticsSection" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">Statistics</h2>
                <div id="statisticsAdminControls" style="display: none;">
                    <button class="btn btn-secondary" onclick="resetStatistics()" style="font-size: 14px; padding: 8px 15px;">Reset Statistics</button>
                </div>
            </div>
            <div class="games-grid">
                <div class="game-card">
                    <div class="game-icon">üìä</div>
                    <h3>Most Popular Game</h3>
                    <p id="mostPopularGame">Loading...</p>
                </div>
                <div class="game-card">
                    <div class="game-icon">üìÖ</div>
                    <h3>Visits Today</h3>
                    <p id="visitsToday" style="font-size: 32px; font-weight: 900; color: var(--accent-primary);">0</p>
                </div>
                <div class="game-card">
                    <div class="game-icon">üìÜ</div>
                    <h3>Visits This Week</h3>
                    <p id="visitsWeek" style="font-size: 32px; font-weight: 900; color: var(--accent-primary);">0</p>
                </div>
                <div class="game-card">
                    <div class="game-icon">üåê</div>
                    <h3>All Time Visits</h3>
                    <p id="visitsAllTime" style="font-size: 32px; font-weight: 900; color: var(--accent-primary);">0</p>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="section">
            <h2>Admin Panel</h2>
            <div class="game-card">
                <h3>User Management</h3>
                <p>View and manage all registered users</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="loadAllUsers()">View All Users</button>
                    <button class="btn btn-secondary" id="userModeBtn" onclick="toggleUserMode()">User Mode</button>
                    <button class="btn btn-secondary" id="shutdownBtn" onclick="toggleShutdown()">Temp Shutdown</button>
                </div>
            </div>
            <div id="usersList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Maintenance Page -->
    <div id="maintenancePage" class="section" style="display: none;">
        <div style="max-width: 800px; margin: 0 auto; text-align: center; padding: 40px;">
            <h1 style="color: var(--accent-primary); font-size: 48px; margin-bottom: 20px;">GameZone is Not Available Right Now</h1>
            <p style="color: var(--text-secondary); font-size: 20px; margin-bottom: 40px;">
                Probably because some cool new feature is being added. In the meantime, you can play our top games:
            </p>
            <div id="topGamesMaintenance" class="games-grid" style="max-width: 600px; margin: 0 auto;">
                <!-- Top games will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>Login</h2>
            <div id="loginError"></div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Email or Username</label>
                    <input type="text" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">Login</button>
                <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="hideModal('loginModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2>Register</h2>
            <div id="registerError"></div>
            <div id="registerSuccess"></div>
            <form onsubmit="register(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="registerUsername" required minlength="3">
                    <small style="color: var(--text-secondary);">Only letters, numbers, underscores and hyphens</small>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" required>
                    <small style="color: var(--text-secondary);">Use your LWSD email (7 digits@lwsd.org)</small>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" required minlength="6">
                    <small style="color: var(--text-secondary);">Minimum 6 characters</small>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">Register</button>
                <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="hideModal('registerModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div id="verifyModal" class="modal">
        <div class="modal-content">
            <h2>Verify Email</h2>
            <div class="info">
                <strong>Check your email!</strong> We've sent a 6-digit verification code to your email address.
            </div>
            <div id="verifyError"></div>
            <form onsubmit="verifyEmail(event)">
                <div class="form-group">
                    <label>Verification Code</label>
                    <input type="text" id="verifyCode" required maxlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">Verify</button>
                <button type="button" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="resendVerification()">Resend Code</button>
                <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="hideModal('verifyModal')">Later</button>
            </form>
        </div>
    </div>

    <!-- Custom Dialog Modal -->
    <div id="customDialog" class="dialog-modal">
        <div class="dialog-content">
            <h3 id="dialogTitle">Alert</h3>
            <p id="dialogMessage"></p>
            <div class="dialog-buttons" id="dialogButtons"></div>
        </div>
    </div>

    <!-- Announcement Edit/Create Modal -->
    <div id="announcementModal" class="modal">
        <div class="modal-content">
            <h2 id="announcementModalTitle">Create Announcement</h2>
            <form onsubmit="saveAnnouncement(event)">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="announcementTitle" required>
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea id="announcementContent" required style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary); font-size: 16px; font-family: 'Tektur', sans-serif; min-height: 150px; resize: vertical;"></textarea>
                </div>
                <input type="hidden" id="announcementId">
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">Save</button>
                <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="hideModal('announcementModal')">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // EmailJS Configuration - REPLACE THESE WITH YOUR OWN!
        const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY_HERE'; // Get from EmailJS dashboard
        const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID_HERE';
        const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID_HERE';

        // Initialize EmailJS
        if (EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY_HERE') {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        }

        // Custom Alert and Confirm functions
        function customAlert(message, title = 'Alert') {
            return new Promise((resolve) => {
                const dialog = document.getElementById('customDialog');
                const dialogTitle = document.getElementById('dialogTitle');
                const dialogMessage = document.getElementById('dialogMessage');
                const dialogButtons = document.getElementById('dialogButtons');
                
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                dialogButtons.innerHTML = '<button class="btn btn-primary">OK</button>';
                
                dialog.classList.add('active');
                
                // Store resolve function for button click
                const okButton = dialogButtons.querySelector('button');
                okButton.onclick = () => {
                    hideCustomDialog();
                    resolve();
                };
            });
        }

        function customConfirm(message, title = 'Confirm') {
            return new Promise((resolve) => {
                const dialog = document.getElementById('customDialog');
                const dialogTitle = document.getElementById('dialogTitle');
                const dialogMessage = document.getElementById('dialogMessage');
                const dialogButtons = document.getElementById('dialogButtons');
                
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                dialogButtons.innerHTML = `
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary">OK</button>
                `;
                
                dialog.classList.add('active');
                
                const buttons = dialogButtons.querySelectorAll('button');
                buttons[0].onclick = () => {
                    hideCustomDialog();
                    resolve(false);
                };
                buttons[1].onclick = () => {
                    hideCustomDialog();
                    resolve(true);
                };
            });
        }

        function hideCustomDialog() {
            document.getElementById('customDialog').classList.remove('active');
        }

        // Wrapper function for game alerts
        async function showGameAlert(gameName) {
            trackGameClick(gameName);
            await alert('Game launching soon!');
        }

        // Override native alert and confirm
        window.alert = customAlert;
        window.confirm = customConfirm;

        // Storage wrapper - fallback to localStorage if window.storage is not available
        if (!window.storage) {
            window.storage = {
                async get(key, shared) {
                    try {
                        const value = localStorage.getItem(key);
                        if (value === null) {
                            return null;
                        }
                        return { value: value };
                    } catch (error) {
                        console.error('Storage get error:', error);
                        return null;
                    }
                },
                async set(key, value, shared) {
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch (error) {
                        console.error('Storage set error:', error);
                        throw error;
                    }
                },
                async delete(key, shared) {
                    try {
                        localStorage.removeItem(key);
                        return true;
                    } catch (error) {
                        console.error('Storage delete error:', error);
                        throw error;
                    }
                },
                async list(prefix, shared) {
                    try {
                        const keys = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith(prefix)) {
                                keys.push(key);
                            }
                        }
                        return { keys: keys };
                    } catch (error) {
                        console.error('Storage list error:', error);
                        return { keys: [] };
                    }
                }
            };
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon();

        let currentUser = null;
        let currentChatRoom = 'general';
        
        // Secure admin check - stored server-side in shared storage
        async function getAdminEmail() {
            try {
                const adminData = await window.storage.get('admin_email', true);
                if (adminData) {
                    return adminData.value;
                }
                // First time setup - set admin email
                await window.storage.set('admin_email', 'tiemppo.gamezone2@gmail.com', true);
                return 'tiemppo.gamezone2@gmail.com';
            } catch (error) {
                return 'tiemppo.gamezone2@gmail.com';
            }
        }
        
        let ADMIN_EMAIL = null;
        
        // Initialize admin email on load
        (async () => {
            ADMIN_EMAIL = await getAdminEmail();
        })();

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const theme = document.documentElement.getAttribute('data-theme');
            const moonIcon = document.getElementById('moonIcon');
            const sunIcon = document.getElementById('sunIcon');
            
            if (theme === 'dark') {
                // Show sun icon (dark mode active, click to switch to light)
                moonIcon.style.display = 'none';
                sunIcon.style.display = 'block';
            } else {
                // Show moon icon (light mode active, click to switch to dark)
                moonIcon.style.display = 'block';
                sunIcon.style.display = 'none';
            }
        }

        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
            
            // Clear all form inputs and messages when closing modals
            if (id === 'registerModal') {
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerError').innerHTML = '';
                document.getElementById('registerSuccess').innerHTML = '';
            }
            
            if (id === 'loginModal') {
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').innerHTML = '';
            }
            
            if (id === 'verifyModal') {
                document.getElementById('verifyCode').value = '';
                document.getElementById('verifyError').innerHTML = '';
            }
        }

        async function getClientIP() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            const fingerprint = canvas.toDataURL();
            
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'fp_' + Math.abs(hash).toString(36);
        }

        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function sendVerificationEmail(email, username, code) {
            if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY_HERE') {
                console.log(`Verification code for ${email}: ${code}`);
                await alert(`Demo Mode: Your verification code is ${code}\n\nIn production, this would be sent to ${email}`);
                return;
            }

            try {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                    to_email: email,
                    to_name: username,
                    verification_code: code,
                    subject: 'GameZone II - Email Verification'
                });
                console.log('Verification email sent successfully');
            } catch (error) {
                console.error('Email send failed:', error);
            }
        }

        async function register(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.toLowerCase().trim();
            const password = document.getElementById('registerPassword').value;

            // Clear previous messages
            document.getElementById('registerError').innerHTML = '';
            document.getElementById('registerSuccess').innerHTML = '';

            // Validate all fields are filled
            if (!username || !email || !password) {
                const errorDiv = document.getElementById('registerError');
                errorDiv.innerHTML = '<div class="error">Please fill out all fields!</div>';
                requestAnimationFrame(() => {
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
                return;
            }

            // Validate username (only letters, numbers, underscore, hyphen)
            const usernameRegex = /^[a-zA-Z0-9_-]+$/;
            if (!usernameRegex.test(username)) {
                const errorDiv = document.getElementById('registerError');
                errorDiv.innerHTML = '<div class="error">Username can only contain letters, numbers, underscores (_), and hyphens (-).</div>';
                requestAnimationFrame(() => {
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
                return;
            }

            // Validate email format (7 digits @lwsd.org OR tiemppo.gamezone2@gmail.com)
            const adminEmail = 'tiemppo.gamezone2@gmail.com';
            const lwsdEmailRegex = /^\d{7}@lwsd\.org$/;
            
            if (email !== adminEmail && !lwsdEmailRegex.test(email)) {
                const errorDiv = document.getElementById('registerError');
                errorDiv.innerHTML = '<div class="error">Email must be in format: 1234567@lwsd.org (7 digits followed by @lwsd.org)</div>';
                requestAnimationFrame(() => {
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
                return;
            }

            // Validate password length
            if (password.length < 6) {
                const errorDiv = document.getElementById('registerError');
                errorDiv.innerHTML = '<div class="error">Password must be at least 6 characters long!</div>';
                requestAnimationFrame(() => {
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
                return;
            }

            try {
                const clientIP = await getClientIP();
                
                const ipCheck = await window.storage.get(`ip:${clientIP}`, true);
                if (ipCheck) {
                    const errorDiv = document.getElementById('registerError');
                    errorDiv.innerHTML = '<div class="error">You have already created an account with this device. Please do not make multiple accounts.</div>';
                    requestAnimationFrame(() => {
                        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    });
                    return;
                }

                const existingUser = await window.storage.get(`user:${email}`, true);
                if (existingUser) {
                    const errorDiv = document.getElementById('registerError');
                    errorDiv.innerHTML = '<div class="error">Email already registered!</div>';
                    requestAnimationFrame(() => {
                        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    });
                    return;
                }

                const verificationCode = generateVerificationCode();
                const adminEmailAddress = await getAdminEmail();
                
                const userData = {
                    username,
                    email,
                    password: btoa(password),
                    isAdmin: email === adminEmailAddress,
                    createdAt: new Date().toISOString(),
                    verified: false,
                    verificationCode: verificationCode,
                    ip: clientIP
                };

                await window.storage.set(`user:${email}`, JSON.stringify(userData), true);
                await window.storage.set(`ip:${clientIP}`, email, true);

                // Show success message immediately
                document.getElementById('registerSuccess').innerHTML = '<div class="success">Account created successfully! Verification email sent - you should receive it soon!</div>';

                // Send verification email
                await sendVerificationEmail(email, username, verificationCode);

                localStorage.setItem('pendingVerification', email);
                
                setTimeout(() => {
                    hideModal('registerModal');
                    showModal('verifyModal');
                    document.getElementById('registerSuccess').innerHTML = '';
                }, 3000);
            } catch (error) {
                console.error('Registration error:', error);
                const errorDiv = document.getElementById('registerError');
                errorDiv.innerHTML = '<div class="error">Registration failed. Please try again. Error: ' + error.message + '</div>';
                requestAnimationFrame(() => {
                    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
            }
        }

        async function verifyEmail(e) {
            e.preventDefault();
            const code = document.getElementById('verifyCode').value;
            const email = localStorage.getItem('pendingVerification');

            if (!email) {
                document.getElementById('verifyError').innerHTML = '<div class="error">No pending verification found.</div>';
                return;
            }

            try {
                const userData = await window.storage.get(`user:${email}`, true);
                if (!userData) {
                    document.getElementById('verifyError').innerHTML = '<div class="error">User not found.</div>';
                    return;
                }

                const user = JSON.parse(userData.value);

                if (user.verificationCode === code) {
                    user.verified = true;
                    await window.storage.set(`user:${email}`, JSON.stringify(user), true);
                    
                    localStorage.removeItem('pendingVerification');
                    currentUser = user;
                    localStorage.setItem('currentUser', email);
                    
                    hideModal('verifyModal');
                    updateUI();
                    await alert('Email verified successfully! Welcome to GameZone II!');
                } else {
                    document.getElementById('verifyError').innerHTML = '<div class="error">Invalid verification code!</div>';
                }
            } catch (error) {
                document.getElementById('verifyError').innerHTML = '<div class="error">Verification failed. Please try again.</div>';
            }
        }

        async function resendVerification() {
            const email = localStorage.getItem('pendingVerification');
            if (!email) {
                await alert('No pending verification found.');
                return;
            }

            try {
                const userData = await window.storage.get(`user:${email}`, true);
                if (!userData) return;

                const user = JSON.parse(userData.value);
                const newCode = generateVerificationCode();
                user.verificationCode = newCode;
                
                await window.storage.set(`user:${email}`, JSON.stringify(user), true);
                await sendVerificationEmail(email, user.username, newCode);
                
                await alert('Verification code resent! Check your email.');
            } catch (error) {
                await alert('Failed to resend code.');
            }
        }

        async function login(e) {
            e.preventDefault();
            const loginInput = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            // Clear previous errors
            document.getElementById('loginError').innerHTML = '';

            // Validate fields
            if (!loginInput || !password) {
                document.getElementById('loginError').innerHTML = '<div class="error">Please fill out all fields!</div>';
                return;
            }

            try {
                let userData = null;
                let userEmail = null;

                // Try to find user by email first
                const emailInput = loginInput.toLowerCase();
                userData = await window.storage.get(`user:${emailInput}`, true);
                
                if (userData) {
                    userEmail = emailInput;
                } else {
                    // If not found by email, search by username
                    const allUsers = await window.storage.list('user:', true);
                    if (allUsers && allUsers.keys) {
                        for (const key of allUsers.keys) {
                            const user = await window.storage.get(key, true);
                            if (user) {
                                const userObj = JSON.parse(user.value);
                                if (userObj.username.toLowerCase() === loginInput.toLowerCase()) {
                                    userData = user;
                                    userEmail = userObj.email;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                if (!userData) {
                    document.getElementById('loginError').innerHTML = '<div class="error">Invalid credentials!</div>';
                    return;
                }

                const user = JSON.parse(userData.value);

                if (btoa(password) !== user.password) {
                    document.getElementById('loginError').innerHTML = '<div class="error">Invalid credentials!</div>';
                    return;
                }

                currentUser = user;
                localStorage.setItem('currentUser', userEmail);
                
                // Track visit
                await trackVisit();
                
                if (!user.verified) {
                    localStorage.setItem('pendingVerification', userEmail);
                }
                
                updateUI();
                hideModal('loginModal');
                document.getElementById('loginError').innerHTML = '';
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginError').innerHTML = '<div class="error">Login failed. Please try again.</div>';
            }
        }

        async function logout() {
            const confirmed = await confirm('Are you sure you want to logout?');
            if (confirmed) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                updateUI();
            }
        }

        async function trackVisit() {
            try {
                const today = new Date().toDateString();
                const now = Date.now();
                const weekAgo = now - (7 * 24 * 60 * 60 * 1000);
                
                // Get current visit stats
                const statsData = await window.storage.get('visit_stats', true);
                let stats = { visits: [], lastVisit: null };
                
                if (statsData) {
                    stats = JSON.parse(statsData.value);
                }
                
                // Add current visit
                stats.visits.push(now);
                stats.lastVisit = now;
                
                // Clean up old visits (older than 30 days)
                const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000);
                stats.visits = stats.visits.filter(v => v > thirtyDaysAgo);
                
                await window.storage.set('visit_stats', JSON.stringify(stats), true);
            } catch (error) {
                console.error('Failed to track visit:', error);
            }
        }

        async function trackGameClick(gameName) {
            try {
                const gameStatsData = await window.storage.get('game_stats', true);
                let gameStats = {};
                
                if (gameStatsData) {
                    gameStats = JSON.parse(gameStatsData.value);
                }
                
                if (!gameStats[gameName]) {
                    gameStats[gameName] = 0;
                }
                
                gameStats[gameName]++;
                
                await window.storage.set('game_stats', JSON.stringify(gameStats), true);
                
                // Track recent games
                if (currentUser) {
                    const userEmail = localStorage.getItem('currentUser');
                    const recentGamesData = await window.storage.get(`recent_games:${userEmail}`, true);
                    let recentGames = [];
                    
                    if (recentGamesData) {
                        recentGames = JSON.parse(recentGamesData.value);
                    }
                    
                    // Add game to recent games (most recent first)
                    recentGames.unshift({
                        name: gameName,
                        timestamp: Date.now()
                    });
                    
                    // Keep only last 6 games
                    recentGames = recentGames.slice(0, 6);
                    
                    await window.storage.set(`recent_games:${userEmail}`, JSON.stringify(recentGames), true);
                    
                    // Update recent games if on home page
                    if (document.getElementById('homeSection').classList.contains('active')) {
                        await loadRecentGames();
                    }
                }
                
                // Update statistics if on statistics page
                if (document.getElementById('statisticsSection').classList.contains('active')) {
                    await loadStatistics();
                }
            } catch (error) {
                console.error('Failed to track game click:', error);
            }
        }

        async function loadRecentGames() {
            try {
                if (!currentUser) return;
                
                const userEmail = localStorage.getItem('currentUser');
                const recentGamesData = await window.storage.get(`recent_games:${userEmail}`, true);
                let recentGames = [];
                
                if (recentGamesData) {
                    recentGames = JSON.parse(recentGamesData.value);
                }
                
                const recentGamesList = document.getElementById('recentGamesList');
                
                if (recentGames.length === 0) {
                    recentGamesList.innerHTML = `
                        <div class="game-card" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                            <p style="color: var(--text-secondary);">No games played yet. Start playing to see your recent games here!</p>
                        </div>
                    `;
                } else {
                    const gameIcons = {
                        'Aim Trainer': 'üéØ',
                        'Memory Match': 'üß©',
                        'Type Racer': '‚å®Ô∏è',
                        'Math Blast': 'üßÆ',
                        'Space Shooter': 'üöÄ',
                        'Endless Runner': 'üèÉ'
                    };
                    
                    recentGamesList.innerHTML = recentGames.map(game => {
                        const icon = gameIcons[game.name] || 'üéÆ';
                        const timeAgo = getTimeAgo(game.timestamp);
                        return `
                            <div class="game-card">
                                <div class="game-icon">${icon}</div>
                                <h3>${game.name}</h3>
                                <p style="color: var(--text-secondary); font-size: 14px;">Played ${timeAgo}</p>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Failed to load recent games:', error);
            }
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            return 'just now';
        }

        async function loadStatistics() {
            try {
                // Load visit statistics
                const statsData = await window.storage.get('visit_stats', true);
                let visits = [];
                
                if (statsData) {
                    const stats = JSON.parse(statsData.value);
                    visits = stats.visits || [];
                }
                
                const now = Date.now();
                const todayStart = new Date().setHours(0, 0, 0, 0);
                const weekAgo = now - (7 * 24 * 60 * 60 * 1000);
                
                const visitsToday = visits.filter(v => v >= todayStart).length;
                const visitsWeek = visits.filter(v => v >= weekAgo).length;
                const visitsAllTime = visits.length;
                
                document.getElementById('visitsToday').textContent = visitsToday;
                document.getElementById('visitsWeek').textContent = visitsWeek;
                document.getElementById('visitsAllTime').textContent = visitsAllTime;
                
                // Load game statistics
                const gameStatsData = await window.storage.get('game_stats', true);
                let gameStats = {};
                
                if (gameStatsData) {
                    gameStats = JSON.parse(gameStatsData.value);
                }
                
                let mostPopular = 'No games played yet';
                let maxClicks = 0;
                
                for (const [gameName, clicks] of Object.entries(gameStats)) {
                    if (clicks > maxClicks) {
                        maxClicks = clicks;
                        mostPopular = gameName;
                    }
                }
                
                document.getElementById('mostPopularGame').textContent = mostPopular + (maxClicks > 0 ? ` (${maxClicks} clicks)` : '');
                
                // Show/hide admin controls for statistics
                const statisticsAdminControls = document.getElementById('statisticsAdminControls');
                const showControls = currentUser && currentUser.isAdmin && !isUserMode;
                if (statisticsAdminControls) {
                    statisticsAdminControls.style.display = showControls ? 'flex' : 'none';
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        // Admin Functions
        let isUserMode = false;
        let isShutdown = false;

        async function toggleUserMode() {
            isUserMode = !isUserMode;
            const btn = document.getElementById('userModeBtn');
            if (isUserMode) {
                btn.textContent = 'Admin Mode';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            } else {
                btn.textContent = 'User Mode';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            }
            updateUI();
        }

        async function toggleShutdown() {
            if (isUserMode) {
                await alert('Shutdown is unavailable in User Mode. Switch to Admin Mode first.');
                return;
            }

            isShutdown = !isShutdown;
            const btn = document.getElementById('shutdownBtn');
            
            if (isShutdown) {
                btn.textContent = 'Enable Site';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                await window.storage.set('site_shutdown', 'true', true);
                await loadTopGamesForMaintenance();
            } else {
                btn.textContent = 'Temp Shutdown';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                await window.storage.set('site_shutdown', 'false', true);
            }
            
            checkShutdown();
        }

        async function checkShutdown() {
            try {
                const shutdownData = await window.storage.get('site_shutdown', true);
                const isShutdownActive = shutdownData && shutdownData.value === 'true';
                isShutdown = isShutdownActive;
                
                // Update shutdown button state
                const shutdownBtn = document.getElementById('shutdownBtn');
                if (shutdownBtn) {
                    if (isShutdown) {
                        shutdownBtn.textContent = 'Enable Site';
                        shutdownBtn.classList.remove('btn-secondary');
                        shutdownBtn.classList.add('btn-primary');
                    } else {
                        shutdownBtn.textContent = 'Temp Shutdown';
                        shutdownBtn.classList.remove('btn-primary');
                        shutdownBtn.classList.add('btn-secondary');
                    }
                }
                
                // Admin can always access, unless in user mode
                if (currentUser && currentUser.isAdmin && !isUserMode) {
                    document.getElementById('maintenancePage').style.display = 'none';
                    return; // Admin bypasses shutdown
                }
                
                if (isShutdownActive) {
                    // Hide all sections except maintenance
                    document.querySelectorAll('.section').forEach(s => {
                        if (s.id !== 'maintenancePage') {
                            s.style.display = 'none';
                        }
                    });
                    document.getElementById('maintenancePage').style.display = 'block';
                    document.getElementById('maintenancePage').classList.add('active');
                    if (document.getElementById('navTabs')) {
                        document.getElementById('navTabs').innerHTML = '';
                    }
                    await loadTopGamesForMaintenance();
                } else {
                    document.getElementById('maintenancePage').style.display = 'none';
                    document.getElementById('maintenancePage').classList.remove('active');
                }
            } catch (error) {
                console.error('Failed to check shutdown:', error);
            }
        }

        async function loadTopGamesForMaintenance() {
            try {
                const gameStatsData = await window.storage.get('game_stats', true);
                let gameStats = {};
                
                if (gameStatsData) {
                    gameStats = JSON.parse(gameStatsData.value);
                }
                
                // Get top 3 games
                const sortedGames = Object.entries(gameStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([name]) => name);
                
                const gameIcons = {
                    'Aim Trainer': 'üéØ',
                    'Memory Match': 'üß©',
                    'Type Racer': '‚å®Ô∏è',
                    'Math Blast': 'üßÆ',
                    'Space Shooter': 'üöÄ',
                    'Endless Runner': 'üèÉ'
                };
                
                const gameLinks = {
                    'Aim Trainer': '#games',
                    'Memory Match': '#games',
                    'Type Racer': '#games',
                    'Math Blast': '#games',
                    'Space Shooter': '#games',
                    'Endless Runner': '#games'
                };
                
                const topGamesDiv = document.getElementById('topGamesMaintenance');
                
                if (sortedGames.length === 0) {
                    topGamesDiv.innerHTML = `
                        <div class="game-card" style="grid-column: 1 / -1;">
                            <p style="color: var(--text-secondary);">No games have been played yet.</p>
                        </div>
                    `;
                } else {
                    topGamesDiv.innerHTML = sortedGames.map(gameName => {
                        const icon = gameIcons[gameName] || 'üéÆ';
                        return `
                            <div class="game-card">
                                <div class="game-icon">${icon}</div>
                                <h3>${gameName}</h3>
                                <button class="btn btn-primary" onclick="window.location.href='#games'">Play Now</button>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Failed to load top games:', error);
            }
        }

        async function loadAnnouncements() {
            try {
                const announcementsData = await window.storage.get('announcements', true);
                let announcements = [];
                
                if (announcementsData) {
                    announcements = JSON.parse(announcementsData.value);
                } else {
                    // Default announcement
                    announcements = [{
                        id: 'default',
                        title: 'Welcome to GameZone II!',
                        content: 'Welcome to the new and improved GameZone II! We\'re excited to have you here. Check out the games, climb the leaderboard, and join the community chat. More features coming soon!',
                        author: 'Admin',
                        timestamp: Date.now()
                    }];
                }
                
                const announcementsList = document.getElementById('announcementsList');
                const showControls = currentUser && currentUser.isAdmin && !isUserMode;
                
                announcementsList.innerHTML = announcements.map(announcement => {
                    const timeAgo = getTimeAgo(announcement.timestamp);
                    return `
                        <div class="game-card" data-announcement-id="${announcement.id}" style="margin-bottom: 20px;">
                            <h3>${announcement.title}</h3>
                            <p><strong>Posted by ${announcement.author}</strong> ‚Ä¢ ${timeAgo}</p>
                            <p>${announcement.content}</p>
                            ${showControls ? `
                                <div class="announcement-admin-controls" style="display: flex; margin-top: 15px; gap: 10px;">
                                    <button class="btn btn-secondary" onclick="editAnnouncement('${announcement.id}')" style="font-size: 12px; padding: 5px 10px;">Edit</button>
                                    <button class="btn btn-secondary" onclick="deleteAnnouncement('${announcement.id}')" style="font-size: 12px; padding: 5px 10px;">Delete</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                // Show/hide admin controls
                const adminControls = document.getElementById('announcementsAdminControls');
                if (adminControls) {
                    adminControls.style.display = showControls ? 'flex' : 'none';
                }
            } catch (error) {
                console.error('Failed to load announcements:', error);
            }
        }

        function showCreateAnnouncementModal() {
            document.getElementById('announcementModalTitle').textContent = 'Create Announcement';
            document.getElementById('announcementId').value = '';
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            showModal('announcementModal');
        }

        async function editAnnouncement(id) {
            try {
                const announcementsData = await window.storage.get('announcements', true);
                let announcements = [];
                
                if (announcementsData) {
                    announcements = JSON.parse(announcementsData.value);
                }
                
                const announcement = announcements.find(a => a.id === id);
                if (!announcement) {
                    await alert('Announcement not found.');
                    return;
                }
                
                document.getElementById('announcementModalTitle').textContent = 'Edit Announcement';
                document.getElementById('announcementId').value = id;
                document.getElementById('announcementTitle').value = announcement.title;
                document.getElementById('announcementContent').value = announcement.content;
                showModal('announcementModal');
            } catch (error) {
                console.error('Failed to edit announcement:', error);
            }
        }

        async function saveAnnouncement(e) {
            e.preventDefault();
            try {
                const id = document.getElementById('announcementId').value;
                const title = document.getElementById('announcementTitle').value.trim();
                const content = document.getElementById('announcementContent').value.trim();
                
                if (!title || !content) {
                    await alert('Please fill in all fields.');
                    return;
                }
                
                const announcementsData = await window.storage.get('announcements', true);
                let announcements = [];
                
                if (announcementsData) {
                    announcements = JSON.parse(announcementsData.value);
                }
                
                if (id) {
                    // Edit existing
                    const index = announcements.findIndex(a => a.id === id);
                    if (index !== -1) {
                        announcements[index].title = title;
                        announcements[index].content = content;
                        announcements[index].timestamp = Date.now();
                    }
                } else {
                    // Create new
                    const newId = 'announcement_' + Date.now();
                    announcements.unshift({
                        id: newId,
                        title,
                        content,
                        author: currentUser.username,
                        timestamp: Date.now()
                    });
                }
                
                await window.storage.set('announcements', JSON.stringify(announcements), true);
                hideModal('announcementModal');
                await loadAnnouncements();
            } catch (error) {
                console.error('Failed to save announcement:', error);
                await alert('Failed to save announcement.');
            }
        }

        async function deleteAnnouncement(id) {
            if (id === 'default') {
                await alert('Cannot delete the default announcement.');
                return;
            }
            
            const confirmed = await confirm('Are you sure you want to delete this announcement?');
            if (!confirmed) return;
            
            try {
                const announcementsData = await window.storage.get('announcements', true);
                let announcements = [];
                
                if (announcementsData) {
                    announcements = JSON.parse(announcementsData.value);
                }
                
                announcements = announcements.filter(a => a.id !== id);
                await window.storage.set('announcements', JSON.stringify(announcements), true);
                await loadAnnouncements();
            } catch (error) {
                console.error('Failed to delete announcement:', error);
                await alert('Failed to delete announcement.');
            }
        }

        async function resetStatistics() {
            const confirmed = await confirm('Are you sure you want to reset all statistics? This cannot be undone.');
            if (!confirmed) return;
            
            try {
                await window.storage.set('visit_stats', JSON.stringify({ visits: [], lastVisit: null }), true);
                await window.storage.set('game_stats', JSON.stringify({}), true);
                
                // Reset per-user recent games
                const allUsers = await window.storage.list('user:', true);
                if (allUsers && allUsers.keys) {
                    for (const key of allUsers.keys) {
                        const userData = await window.storage.get(key, true);
                        if (userData) {
                            const user = JSON.parse(userData.value);
                            await window.storage.set(`recent_games:${user.email}`, JSON.stringify([]), true);
                        }
                    }
                }
                
                await alert('Statistics have been reset successfully.');
                
                // Reload statistics and recent games
                if (document.getElementById('statisticsSection').classList.contains('active')) {
                    await loadStatistics();
                }
                if (document.getElementById('homeSection').classList.contains('active')) {
                    await loadRecentGames();
                }
            } catch (error) {
                console.error('Failed to reset statistics:', error);
                await alert('Failed to reset statistics.');
            }
        }

        async function checkAutoLogin() {
            // Check shutdown first
            await checkShutdown();
            
            const email = localStorage.getItem('currentUser');
            if (email) {
                try {
                    const userData = await window.storage.get(`user:${email}`, true);
                    if (userData) {
                        currentUser = JSON.parse(userData.value);
                        await trackVisit();
                        updateUI();
                    }
                } catch (error) {
                    console.error('Auto-login failed:', error);
                }
            } else {
                updateUI();
            }
        }

        function getUserLevel() {
            // Placeholder - will be implemented later
            return currentUser?.level || 1;
        }

        function getUserXP() {
            // Placeholder - will be implemented later
            return currentUser?.xp || 0;
        }

        function getUserXPNeeded() {
            // Placeholder - will be implemented later
            return currentUser?.xpNeeded || 100;
        }

        function updateUI() {
            const userInfo = document.getElementById('userInfo');
            const navTabs = document.getElementById('navTabs');

            if (currentUser) {
                const level = getUserLevel();
                const xp = getUserXP();
                const xpNeeded = getUserXPNeeded();

                userInfo.innerHTML = `
                    <div class="user-badge">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span style="font-weight: 700;">${currentUser.username}</span>
                            <div style="display: flex; gap: 10px; align-items: center; font-size: 12px; color: var(--text-secondary);">
                                <span>Level ${level}</span>
                                <span>‚Ä¢</span>
                                <span>XP: ${xp}/${xpNeeded}</span>
                            </div>
                        </div>
                        ${currentUser.isAdmin && !isUserMode ? '<span class="admin-badge">ADMIN</span>' : ''}
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                `;

                let tabs = `
                    <div class="nav-tab active" onclick="switchTab('home')">Home</div>
                    <div class="nav-tab" onclick="switchTab('games')">Games</div>
                    <div class="nav-tab" onclick="switchTab('leaderboard')">Leaderboard</div>
                    <div class="nav-tab" onclick="switchTab('schoolPortal')">School Portal</div>
                    <div class="nav-tab" onclick="switchTab('chat')">Chat</div>
                    <div class="nav-tab" onclick="switchTab('statistics')">Statistics</div>
                `;

                // Admin tab always visible for admins (even in user mode)
                if (currentUser.isAdmin) {
                    tabs += `<div class="nav-tab" onclick="switchTab('admin')">Admin</div>`;
                }

                navTabs.innerHTML = tabs;
                switchTab('home');
            } else {
                userInfo.innerHTML = `
                    <button class="btn btn-primary" onclick="showModal('loginModal')">Login</button>
                    <button class="btn btn-secondary" onclick="showModal('registerModal')">Register</button>
                `;
                navTabs.innerHTML = '';
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(tab + 'Section').classList.add('active');
            
            // Load recent games and announcements when switching to home tab
            if (tab === 'home') {
                loadRecentGames();
                loadAnnouncements();
            }
            
            // Load statistics when switching to statistics tab
            if (tab === 'statistics') {
                loadStatistics();
            }
        }

        function switchChatRoom(room) {
            currentChatRoom = room;
            document.querySelectorAll('.chat-room-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('messagesList').innerHTML = `
                <div class="message">
                    <div class="message-author">System</div>
                    <div>Welcome to #${room}!</div>
                </div>
            `;
        }

        async function sendMessage() {
            if (!currentUser) {
                await alert('Please login to chat!');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="message-author">${currentUser.username}</div>
                <div>${message}</div>
            `;
            
            document.getElementById('messagesList').appendChild(messageDiv);
            input.value = '';
            
            document.getElementById('messagesList').scrollTop = document.getElementById('messagesList').scrollHeight;
        }

        async function loadAllUsers() {
            if (!currentUser || !currentUser.isAdmin) {
                await alert('Admin access required!');
                return;
            }

            try {
                const result = await window.storage.list('user:', true);
                if (!result || !result.keys || result.keys.length === 0) {
                    document.getElementById('usersList').innerHTML = '<div class="game-card">No users found.</div>';
                    return;
                }

                let usersHTML = '<h3 style="margin-top: 20px; color: var(--accent-primary);">All Registered Users</h3>';
                
                for (const key of result.keys) {
                    const userData = await window.storage.get(key, true);
                    if (userData) {
                        const user = JSON.parse(userData.value);
                        const adminEmail = await getAdminEmail();
                        usersHTML += `
                            <div class="game-card" style="margin-top: 10px;">
                                <h3>${user.username} ${user.isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}</h3>
                                <p><strong>Email:</strong> ${user.email}</p>
                                <p><strong>Status:</strong> ${user.verified ? '<span style="color: #44ff44;">‚úì Verified</span>' : '<span style="color: #ff4444;">‚úó Unverified</span>'}</p>
                                <p><strong>Joined:</strong> ${new Date(user.createdAt).toLocaleString()}</p>
                                ${user.email !== adminEmail ? `<button class="btn btn-secondary" onclick="kickUser('${user.email}')">Kick User</button>` : ''}
                            </div>
                        `;
                    }
                }
                
                document.getElementById('usersList').innerHTML = usersHTML;
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersList').innerHTML = '<div class="error">Failed to load users.</div>';
            }
        }

        async function kickUser(email) {
            if (!currentUser || !currentUser.isAdmin) return;
            
            const adminEmail = await getAdminEmail();
            if (email === adminEmail) {
                await alert('Cannot kick the admin!');
                return;
            }
            
            const confirmed = await confirm(`Are you sure you want to kick ${email}?`);
            if (confirmed) {
                try {
                    const userData = await window.storage.get(`user:${email}`, true);
                    if (userData) {
                        const user = JSON.parse(userData.value);
                        await window.storage.delete(`user:${email}`, true);
                        await window.storage.delete(`ip:${user.ip}`, true);
                        await alert(`User ${email} has been kicked.`);
                        loadAllUsers();
                    }
                } catch (error) {
                    await alert('Failed to kick user.');
                }
            }
        }

        checkAutoLogin();
    </script>
</body>
</html>